generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                 String        @id @default(uuid())
  accountNumber      String        @unique
  email              String        @unique
  name               String
  currency           String
  balance            BigInt
  allowOverdraft     Boolean       @default(false)
  passwordHash       String
  transactionPin     String
  securityQuestion   String
  securityAnswerHash String
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  webhookUrl         String?
  apiKeys            ApiKey[]
  entries            Entry[]
  invoices           Invoice[]
  sentTransfers      Transaction[] @relation("sender")
  receivedTransfers  Transaction[] @relation("receiver")
}

model Transaction {
  id             String   @id @default(uuid())
  reference      String
  currency       String
  targetCurrency String?
  exchangeRate   Float?   @default(1.0)
  description    String?
  fromAccountId  String
  toAccountId    String
  status         TxStatus @default(POSTED)
  idempotencyKey String?  @unique
  createdAt      DateTime @default(now())
  type           String?
  amount         BigInt
  entries        Entry[]
  fromAccount    Account  @relation("sender", fields: [fromAccountId], references: [id])
  toAccount      Account  @relation("receiver", fields: [toAccountId], references: [id])
}

model Entry {
  id            String      @id @default(uuid())
  amount        BigInt
  accountId     String
  transactionId String
  createdAt     DateTime    @default(now())
  account       Account     @relation(fields: [accountId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id])

  @@index([accountId])
}

model ApiKey {
  id        String    @id @default(uuid())
  key       String    @unique
  accountId String
  name      String?
  createdAt DateTime  @default(now())
  expiresAt DateTime?
  account   Account   @relation(fields: [accountId], references: [id])
}

model Invoice {
  id                String        @id @default(uuid())
  reference         String        @unique
  amount            BigInt
  status            InvoiceStatus @default(PENDING)
  creditorAccountId String
  paidAt            DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  description       String
  expiresAt         DateTime?
  webhookUrl        String        @default("https://default-webhook.example.com")
  creditorAccount   Account       @relation(fields: [creditorAccountId], references: [id])

  @@index([status])
}

model WebhookEvent {
  id        String        @id @default(uuid())
  endpoint  String
  payload   Json
  status    WebhookStatus @default(PENDING)
  attempts  Int           @default(0)
  lastError String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([status])
}

enum WebhookStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum TxStatus {
  PENDING
  POSTED
  ARCHIVED
  FAILED
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}
