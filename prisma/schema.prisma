generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. THE ACCOUNT (The "Bucket")
model Account {
  id             String   @id @default(uuid())
  accountNumber  String   @unique
  email          String   @unique
  name           String
  currency       String
  balance        BigInt
  allowOverdraft Boolean  @default(false)
  passwordHash       String   
  transactionPin      String  
  securityQuestion   String  
  securityAnswerHash String   
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  sentTransfers     Transaction[] @relation("sender")
  receivedTransfers Transaction[] @relation("receiver")
  entries           Entry[]
  apiKeys           ApiKey[]
  invoices          Invoice[]
}

// 2. THE TRANSACTION (The "Receipt")
model Transaction {
  id             String   @id @default(uuid())
  reference      String
  currency       String
  targetCurrency String?
  exchangeRate   Float?   @default(1.0)
  description    String?
  amount         BigInt   
  fromAccount   Account @relation("sender", fields: [fromAccountId], references: [id])
  fromAccountId String
  toAccount     Account @relation("receiver", fields: [toAccountId], references: [id])
  toAccountId   String
  status         TxStatus @default(POSTED)
  type           String?
  idempotencyKey String?  @unique
  entries        Entry[]
  createdAt      DateTime @default(now())
}

// 3. THE ENTRY (The "Movement")
model Entry {
  id            String      @id @default(uuid())
  amount        BigInt
  accountId     String
  account       Account     @relation(fields: [accountId], references: [id])
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  createdAt     DateTime    @default(now())
  
  @@index([accountId])
}

// 4. API KEY (For External Service Access)
model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique
  accountId String
  account   Account  @relation(fields: [accountId], references: [id])
  name      String?  
  createdAt DateTime @default(now())
  expiresAt DateTime?
}

// 5. INVOICE
model Invoice {
  id                String   @id @default(uuid())
  reference         String   @unique
  amount            BigInt
  description       String
  status            InvoiceStatus @default(PENDING)
  creditorAccountId String
  creditorAccount   Account  @relation(fields: [creditorAccountId], references: [id])
  expiresAt         DateTime? 
  paidAt            DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([status])
}

model WebhookEvent {
  id        String   @id @default(uuid())
  // Who are we sending this to?
  endpoint  String
  payload   Json
  status    WebhookStatus @default(PENDING)
  attempts  Int           @default(0)
  lastError String? 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

enum WebhookStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}


enum TxStatus {
  PENDING
  POSTED
  ARCHIVED
  FAILED
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
}